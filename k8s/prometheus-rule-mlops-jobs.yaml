apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: passos-magicos-mlops-jobs
  namespace: mle-system
  labels:
    release: kps-r8pi
    app: passos-magicos
spec:
  groups:
    - name: passos-magicos-jobs.rules
      rules:
        - alert: PassosMagicosTrainingJobMissingRun
          expr: |
            absent(passos_magicos_job_last_run_timestamp_seconds{job="passos-magicos-train", component="training"})
            or
            (
              time() - max by () (passos_magicos_job_last_run_timestamp_seconds{job="passos-magicos-train", component="training"})
            ) > 691200
          for: 30m
          labels:
            severity: warning
            team: mlops
          annotations:
            summary: "Training CronJob stale or never executed"
            description: "No successful push metric from training job in the last 8 days."

        - alert: PassosMagicosMonitoringJobMissingRun
          expr: |
            absent(passos_magicos_job_last_run_timestamp_seconds{job="passos-magicos-monitoring", component="monitoring"})
            or
            (
              time() - max by () (passos_magicos_job_last_run_timestamp_seconds{job="passos-magicos-monitoring", component="monitoring"})
            ) > 28800
          for: 20m
          labels:
            severity: warning
            team: mlops
          annotations:
            summary: "Monitoring CronJob stale or never executed"
            description: "No push metric from monitoring job in the last 8 hours."

        - alert: PassosMagicosTrainingJobLastRunFailed
          expr: |
            max by () (passos_magicos_job_last_success{job="passos-magicos-train", component="training"}) < 1
          for: 30m
          labels:
            severity: critical
            team: mlops
          annotations:
            summary: "Training CronJob last run failed"
            description: "The latest training job reported failure (last_success=0)."

        - alert: PassosMagicosMonitoringJobLastRunFailed
          expr: |
            max by () (passos_magicos_job_last_success{job="passos-magicos-monitoring", component="monitoring"}) < 1
          for: 20m
          labels:
            severity: warning
            team: mlops
          annotations:
            summary: "Monitoring CronJob last run failed"
            description: "The latest monitoring job reported failure (last_success=0)."

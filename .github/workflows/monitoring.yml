# =============================================================================
# Workflow de Monitoramento e Alertas
# =============================================================================
# Executa verifica√ß√µes peri√≥dicas e envia alertas quando necess√°rio

name: Monitoring & Alerts

on:
  # Execu√ß√£o agendada (a cada 6 horas)
  schedule:
    - cron: '0 */6 * * *'
  
  # Execu√ß√£o manual
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Tipo de verifica√ß√£o'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - drift
          - performance
          - health

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Job: Health Check
  # ==========================================================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'health' || github.event_name == 'schedule'
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install dependencies
        run: |
          pip install requests
      
      - name: üè• Check API Health
        id: health
        continue-on-error: true
        env:
          API_URL: ${{ secrets.PRODUCTION_API_URL }}
        run: |
          if [ -z "$API_URL" ]; then
            echo "‚ö†Ô∏è API_URL n√£o configurada, pulando health check"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ API healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ùå API unhealthy (status: $response)"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "http_code=$response" >> $GITHUB_OUTPUT
          fi
      
      - name: üö® Send Alert (if unhealthy)
        if: steps.health.outputs.status == 'unhealthy'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              --data '{
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "üö® API Health Alert",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n‚ùå Unhealthy"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*HTTP Code:*\n${{ steps.health.outputs.http_code }}"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "A API de produ√ß√£o n√£o est√° respondendo corretamente. Verifique imediatamente!"
                    }
                  }
                ]
              }'
          fi

  # ==========================================================================
  # Job: Drift Detection
  # ==========================================================================
  drift-detection:
    name: üìä Drift Detection
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'drift' || github.event_name == 'schedule'
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: üìä Run Drift Detection
        id: drift
        env:
          PYTHONPATH: ${{ github.workspace }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import os
          import json
          import sys
          
          # Adicionar path
          sys.path.insert(0, os.getcwd())
          
          from src.monitoring import DriftDetector
          from src.monitoring.alerts import get_alert_manager, AlertType, AlertSeverity
          
          print("üîç Iniciando an√°lise de drift...")
          
          # Criar detector
          detector = DriftDetector(enable_alerts=True)
          
          # Analisar predi√ß√µes recentes
          try:
              analysis = detector.analyze_recent_predictions(window_size=100)
              
              # Verificar resultados
              data_drift_detected = analysis.get("data_drift", {}).get("drift_detected", False)
              pred_drift_detected = analysis.get("prediction_drift", {}).get("drift_detected", False)
              
              print(f"üìä Resultados da an√°lise:")
              print(f"   - Data Drift: {'‚ö†Ô∏è DETECTADO' if data_drift_detected else '‚úÖ Normal'}")
              print(f"   - Prediction Drift: {'‚ö†Ô∏è DETECTADO' if pred_drift_detected else '‚úÖ Normal'}")
              
              # Definir outputs para GitHub Actions
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f"data_drift={str(data_drift_detected).lower()}\n")
                  f.write(f"prediction_drift={str(pred_drift_detected).lower()}\n")
              
              if data_drift_detected or pred_drift_detected:
                  print("‚ö†Ô∏è Drift detectado! Alertas ser√£o enviados automaticamente pelo DriftDetector.")
                  sys.exit(1)  # Exit with error to mark job as failed
              else:
                  print("‚úÖ Nenhum drift detectado")
                  
          except Exception as e:
              print(f"‚ùå Erro na an√°lise de drift: {e}")
              # Enviar alerta de erro
              try:
                  alert_manager = get_alert_manager()
                  alert_manager.send_alert(
                      alert_type=AlertType.SYSTEM,
                      severity=AlertSeverity.ERROR,
                      title="Erro na An√°lise de Drift",
                      message=f"Falha ao executar an√°lise de drift: {str(e)}",
                      details={"workflow": "monitoring", "error": str(e)}
                  )
              except:
                  pass
              sys.exit(1)
          EOF
      
      - name: üìù Summary
        if: always()
        run: |
          echo "## üìä Drift Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.drift.outputs.data_drift }}" = "true" ]; then
            echo "‚ö†Ô∏è **Data Drift**: Detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Data Drift**: Normal" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.drift.outputs.prediction_drift }}" = "true" ]; then
            echo "‚ö†Ô∏è **Prediction Drift**: Detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Prediction Drift**: Normal" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # Job: Performance Check
  # ==========================================================================
  performance-check:
    name: üìà Performance Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'performance' || github.event_name == 'schedule'
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: üìà Check Model Performance
        id: performance
        env:
          PYTHONPATH: ${{ github.workspace }}
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          python << 'EOF'
          import os
          import sys
          
          sys.path.insert(0, os.getcwd())
          
          from src.monitoring.metrics import MetricsCollector
          
          print("üìà Verificando performance do modelo...")
          
          metrics = MetricsCollector()
          summary = metrics.get_metrics()
          
          print(f"üìä M√©tricas coletadas:")
          print(f"   - Total de predi√ß√µes: {summary.get('predictions', {}).get('total', 0)}")
          
          # Calcular balance de classes
          pred_data = summary.get('predictions', {})
          total = pred_data.get('total', 0)
          class_1 = pred_data.get('class_1_count', 0)
          
          if total > 0:
              class_1_ratio = class_1 / total
              print(f"   - Ratio classe 1: {class_1_ratio:.2%}")
              
              # Alertar se distribui√ß√£o muito desbalanceada
              if class_1_ratio < 0.1 or class_1_ratio > 0.9:
                  print("‚ö†Ô∏è Distribui√ß√£o de predi√ß√µes muito desbalanceada!")
                  with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                      f.write("imbalanced=true\n")
              else:
                  print("‚úÖ Distribui√ß√£o de predi√ß√µes normal")
                  with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                      f.write("imbalanced=false\n")
          else:
              print("‚ÑπÔ∏è Sem predi√ß√µes para analisar")
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write("imbalanced=false\n")
          EOF
      
      - name: üö® Send Alert (if imbalanced)
        if: steps.performance.outputs.imbalanced == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              --data '{
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "‚ö†Ô∏è Performance Alert",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Distribui√ß√£o de predi√ß√µes est√° muito desbalanceada. Isso pode indicar:\n‚Ä¢ Data drift significativo\n‚Ä¢ Problema no modelo\n‚Ä¢ Mudan√ßa no perfil dos dados de entrada"
                    }
                  }
                ]
              }'
          fi

  # ==========================================================================
  # Job: Summary Report
  # ==========================================================================
  summary:
    name: üìã Summary Report
    runs-on: ubuntu-latest
    needs: [health-check, drift-detection, performance-check]
    if: always()
    
    steps:
      - name: üìã Generate Report
        run: |
          echo "## üìã Monitoring Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üè• Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìä Drift Detection | ${{ needs.drift-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìà Performance Check | ${{ needs.performance-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê Executed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: üö® Final Alert (if any failures)
        if: contains(needs.*.result, 'failure')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              --data '{
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "üö® Monitoring Workflow Alert",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "Um ou mais checks de monitoramento falharam.\n\n‚Ä¢ Health Check: ${{ needs.health-check.result }}\n‚Ä¢ Drift Detection: ${{ needs.drift-detection.result }}\n‚Ä¢ Performance Check: ${{ needs.performance-check.result }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "Ver Workflow"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }'
          fi
